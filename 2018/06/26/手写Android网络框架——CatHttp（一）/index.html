<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="日常技术分享">
    

    <!--Author-->
    
        <meta name="author" content="Pan Hao">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="手写Android网络框架——CatHttp（二）"/>
    

    <!--Open Graph Description-->
    
        <meta property="og:description" content="日常技术分享" />
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="panhaos_blog"/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    

    <meta name="twitter:card" content="summary" />
    

    <!-- Title -->
    
    <title>手写Android网络框架——CatHttp（二） - panhaos_blog</title>

    <!-- Tachyons Core CSS -->
    <link rel="stylesheet" href="//unpkg.com/tachyons/css/tachyons.min.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Google Analytics -->
    


</head>


<body>

<!-- Main Content -->
<!-- Banner -->
<!-- Banner -->
<div class="w-100 bg-1 ph5-ns ph3 text-light">
    
    <nav class="db dt-l w-100 mw8 center border-box pv3">
        <a class="db dtc-l v-mid link dim w-100 w-25-l tc tl-l mb2 mb0-l white" href="/" title="panhaos_blog">
            <img src="http://www.codeblocq.com/assets/projects/hexo-theme-anodyne/assets/anodyne.svg" class="dib h3" alt="panhaos_blog">
        </a>
        <div class="db dtc-l v-mid w-100 w-75-l tc tr-l">
            
                <a class="link dim f6 f5-l dib mr3 mr4-l white" 
                    href="/" 
                    title="主页">
                    主页
                </a>
            
                <a class="link dim f6 f5-l dib mr3 mr4-l white" 
                    href="/archives" 
                    title="档案">
                    档案
                </a>
            
                <a class="link dim f6 f5-l dib mr3 mr4-l white" 
                    href="/about.html" 
                    title="关于">
                    关于
                </a>
            
                <a class="link dim f6 f5-l dib mr3 mr4-l white" 
                    href="/contact.html" 
                    title="联系">
                    联系
                </a>
            
        </div>
    </nav>

    <!-- Title -->
    <div class="w-100 mw8 center vh-40 dt">
        <div class="dtc v-mid white">
            <h1 class="f1-l f2-m tc tc-m tl-ns">手写Android网络框架——CatHttp（二）</h1>
            <p class="f4 fw3 pab-100px tc tc-m tl-ns">2018-06-26</p>
        </div>
    </div>

    <!-- Icon -->
    <div class="relative w-100 mw8 center white dn dn-m db-ns">
        <i class="header-icon fa fa-file-text-o"></i>
    </div>
</div>

<!-- Content -->
<div class="w-100 ph2 ph4-m ph5-l mv5 mv6-l">
    <div class="content">
        <div class="mw8 center">
            <div class="cf">
                <div class="fl w-100 w-70-l mw7 left fw3 lh-copy pr4-ns pr0-m post-content">
                    <!-- Tags Vertical -->
                    

                    <!-- Main Post Content -->
                    <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a><strong>前言</strong></h1><p>在实际<code>Android</code>应用的开发中，网络请求往往是必不可少的。现在有很多优秀的开源网络框架如<code>Volley</code>、<code>Okhttp</code>和<code>Retrofit</code>等，说到框架，很多童鞋信手拈来，反手一个<code>Okhttp</code>+<code>Retrofit</code>+<code>RxJava</code>全家桶。不就是网络请求么，<code>so easy</code>~</p>
<p>不过实际开发过程中，确实会出现各种各样的问题，比如你上传一张图片，服务器那边接收不到，怎么办呢？你看了下自己这边，完全按照标准api来写的，讲道理应该没错吧？这时候打开<code>debug</code>，可是框架内的代码怎么跟进？没看过也不懂啊，所以可能有些童鞋会去阅读源码，可是源码这种东西，不熟悉的话读起来晦涩难懂，当然边读边做源码分析写下几篇博客也是不错的选择。</p>
<p>不过其实最本质的，就是对你框架的业务熟悉，比如网络请求框架，你就必须熟悉<code>Http</code>协议，才可以了解你的表单是怎么封装成数据，以什么结果表示，怎么发出去，接收到的内容又是什么？了解了这些，我们完全可以参考优秀的源码，自己动手去实现一个简易版的。</p>
<p><img src="http://img.blog.csdn.net/20180119100508263?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcGFuODYxMTkwMDc5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast"></p>
<h1 id="Http协议"><a href="#Http协议" class="headerlink" title="Http协议"></a><strong>Http协议</strong></h1><p>谈到网络框架，就不得不说到<code>http</code>协议了，网络框架必须严格按照<code>http</code>协议才能保证客户端和服务器双方数据的正常传输。</p>
<h2 id="Http请求"><a href="#Http请求" class="headerlink" title="Http请求"></a><strong>Http请求</strong></h2><p>一个<code>http</code>请求主要包含以下几个部分：<strong>请求行</strong>（<code>request line</code>）、<strong>请求头</strong>（<code>header</code>）、<strong>空行</strong>和<strong>请求正文</strong>四个部分。</p>
<p>以一个<code>http</code>请求为例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /form.html HTTP/1.1 (CRLF)</span><br><span class="line">Accept:image/gif,image/x-xbitmap,image/jpeg,application/x-shockwave-flash,application/vnd.ms-excel,application/vnd.ms-powerpoint,application/msword,*/*  Accept-Language:zh-cn (CRLF)</span><br><span class="line">Accept-Encoding:gzip,deflate (CRLF)</span><br><span class="line">If-Modified-Since:Wed,05 Jan 2007 11:21:25 GMT (CRLF)</span><br><span class="line">If-None-Match:W/&quot;80b1a4c018f3c41:8317&quot; (CRLF)</span><br><span class="line">User-Agent:Mozilla/4.0(compatible;MSIE6.0;Windows NT 5.0) (CRLF)</span><br><span class="line">Host:www.guet.edu.cn (CRLF)</span><br><span class="line">Connection:Keep-Alive (CRLF)</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>请求行</strong>：用来说明请求类型、要访问的资源及使用的Http版本。</li>
<li><strong>请求头</strong>：从第二行起为头部，用来说明服务器要是用的附加信息，一般以键值对的方式出现，中间以‘：’隔开，如 <code>Accept-Language:zh-cn</code>。常用的请求头请看：<a href="http://tools.jb51.net/table/http_header" target="_blank" rel="noopener">Http请求头大全</a>，支持用户自定义请求头。</li>
<li><strong>空行</strong>：在请求头和请求正文中间会有一个空行用来分割，说明请求头和正文的区别。即使后面的正文为空，这里的空行也是必须的。</li>
<li><strong>请求正文</strong>：即我们要发送的数据，平时我们传入的表单、文件等，都会以正文的形式存在于请求正文中，如果是<code>get</code>、<code>delete</code>等请求，请求正文必须为空。</li>
</ul>
<h2 id="Http响应"><a href="#Http响应" class="headerlink" title="Http响应"></a><strong>Http响应</strong></h2><p><code>HTTP</code>响应也由四个部分组成，分别是：<strong>状态行</strong>、<strong>响应头</strong>、<strong>空行</strong>和<strong>响应正文</strong>。<br>这里也以一段<code>http</code>响应为例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Date: Fri, 22 May 2009 06:07:21 GMT</span><br><span class="line">Content-Type: text/html; charset=UTF-8</span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">      &lt;head&gt;&lt;/head&gt;</span><br><span class="line">      &lt;body&gt;</span><br><span class="line">            &lt;!--body goes here--&gt;</span><br><span class="line">      &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>状态行</strong>：由<code>HTTP</code>协议版本号， 状态码， 状态消息 三部分组成。</li>
<li><strong>响应头</strong>：用来说明客户端要使用的一些附加信息，也是和上面的请求头相对应，以键值对的方式。</li>
<li><strong>空行</strong>：和请求的空行一样，这里的空行也是必须的，不管后面的正文是否为空。</li>
<li><strong>响应正文</strong>：服务器返回给客户端的文本信息（二进制形式）</li>
</ul>
<p><img src="http://img.blog.csdn.net/20180119114310567?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcGFuODYxMTkwMDc5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h1 id="技术选型"><a href="#技术选型" class="headerlink" title="技术选型"></a><strong>技术选型</strong></h1><p>大概了解了<code>Http</code>，我们就得选择一种具体的方式或者说一个比较底层的api来作为实现网络访问的实际参与者。大概有三种选择——<code>Socket</code>、<code>HttpClient</code>和<code>HttpUrlConnection</code>。如果是基于<code>Socket</code>那么我们需要实现的内容比较多，当然目前的OkHttp是采用这种方式来的，毕竟socket进行操作自由度比较高，如内部socket连接池的分配，长连接短连接等都可以控制，自由度较高。而<code>HttpClient</code>在<code>Android6.0</code>以后官方已经移除了这个<code>api</code>，而<code>HttpUrlConnection</code>则是一个比较好的选择，足够轻量级，又实现了一些基本需求，因此以<code>HttpUrlConnection</code>作为实际网络请求的参与者。</p>
<h1 id="构建方式"><a href="#构建方式" class="headerlink" title="构建方式"></a><strong>构建方式</strong></h1><p>因为觉得<code>Okhttp</code>的构建方式很优雅，这里我们的构建方式就以<code>OkHttp</code>的方式进行构建，根据上面的<code>Http</code>协议的分析，结合<code>OkHttp</code>的构建方式，对对象的抽象其实也就一目了然了。必然是支持同步和异步的方式发起请求，所以我们的构建方式基本如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">FormBody body = new FormBody.Builder()</span><br><span class="line">                .add(&quot;username&quot;, &quot;浩哥&quot;)</span><br><span class="line">                .add(&quot;pwd&quot;, &quot;abc&quot;)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">Request request = new Request.Builder()</span><br><span class="line">                .url(&quot;http://192.168.31.34:8080/API/upkeep&quot;)</span><br><span class="line">                .post(body)</span><br><span class="line">                .build();</span><br><span class="line">                </span><br><span class="line">client.newCall(request).enqueue(new Callback() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void onResponse(Response response) &#123;</span><br><span class="line">                if (response.code() == 200) &#123;</span><br><span class="line">                    String msg = response.body().string();</span><br><span class="line">                    Logger.e(&quot;response msg = &quot; + msg);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void onFail(Request request, IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>
<p>主要抽象出的对象包括：<strong>Request</strong>、<strong>RequestBody</strong>、<strong>Response</strong>、<strong>ResponseBody</strong>、 <strong>Call</strong>、<strong>CallBack</strong>等。</p>
<h2 id="Request请求的构建"><a href="#Request请求的构建" class="headerlink" title="Request请求的构建"></a><strong>Request请求的构建</strong></h2><p>请求怎么构建呢？结合上面对<code>http</code>协议的分析，请求包括起始行、请求头、空行和请求正文。因为基于<code>HttpUrlConnection</code>，所以起始行和空行可以不用考虑，请求头需要一个临时的暂存空间，请求正文由于不同类型格式也不同，因此请求正文给一个抽象的基类。</p>
<h3 id="RequestBody"><a href="#RequestBody" class="headerlink" title="RequestBody"></a><strong>RequestBody</strong></h3><p><code>requestBody</code>主要负责对流的写出和<code>ContentType</code>类型的构建，因为不同类型如表单和文件的<code>Content-Type</code>内容是不一致的，服务器那边解析方式自然也是不一样的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public abstract class RequestBody &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * body的类型</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    abstract String contentType();</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 将内容写出去</span><br><span class="line">     *</span><br><span class="line">     * @param ous</span><br><span class="line">     */</span><br><span class="line">    abstract void writeTo(OutputStream ous) throws IOException;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Request"><a href="#Request" class="headerlink" title="Request"></a><strong>Request</strong></h2><p>请求这块存储了<code>url</code>，和请求的方法类型，用<code>ArrayMap</code>来存储请求头，同时持有一个<code>RequestBody</code>的引用，均可以通过建造者模式构建进来。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">public class Request &#123;</span><br><span class="line"></span><br><span class="line">    final HttpMethod method;</span><br><span class="line">    final String url;</span><br><span class="line">    final Map&lt;String, String&gt; heads;</span><br><span class="line">    final RequestBody body;</span><br><span class="line"></span><br><span class="line">    public Request(Builder builder) &#123;</span><br><span class="line">        this.method = builder.method;</span><br><span class="line">        this.url = builder.url;</span><br><span class="line">        this.heads = builder.heads;</span><br><span class="line">        this.body = builder.body;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public static final class Builder &#123;</span><br><span class="line"></span><br><span class="line">        HttpMethod method;</span><br><span class="line">        String url;</span><br><span class="line">        Map&lt;String, String&gt; heads;</span><br><span class="line">        RequestBody body;</span><br><span class="line"></span><br><span class="line">        public Builder() &#123;</span><br><span class="line">            this.method = HttpMethod.GET;</span><br><span class="line">            this.heads = new ArrayMap&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Builder(Request request) &#123;</span><br><span class="line">            this.method = request.method;</span><br><span class="line">            this.url = request.url;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        public Builder url(String url) &#123;</span><br><span class="line">            this.url = url;</span><br><span class="line">            return this;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public Builder header(String name, String value) &#123;</span><br><span class="line">            Util.checkMap(name, value);</span><br><span class="line">            heads.put(name, value);</span><br><span class="line">            return this;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public Builder get() &#123;</span><br><span class="line">            method(HttpMethod.GET, null);</span><br><span class="line">            return this;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public Builder post(RequestBody body) &#123;</span><br><span class="line">            method(HttpMethod.POST, body);</span><br><span class="line">            return this;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public Builder put(RequestBody body) &#123;</span><br><span class="line">            method(HttpMethod.PUT, body);</span><br><span class="line">            return this;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public Builder delete(RequestBody body) &#123;</span><br><span class="line">            method(HttpMethod.DELETE, body);</span><br><span class="line">            return this;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public Builder method(HttpMethod method, RequestBody body) &#123;</span><br><span class="line">            Util.checkMethod(method, body);</span><br><span class="line">            this.method = method;</span><br><span class="line">            this.body = body;</span><br><span class="line">            return this;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public Request build() &#123;</span><br><span class="line">            if (url == null) &#123;</span><br><span class="line">                throw new IllegalStateException(&quot;访问url不能为空&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            if (body != null) &#123;</span><br><span class="line">                if (!TextUtils.isEmpty(body.contentType())) &#123;</span><br><span class="line">                    heads.put(&quot;Content-Type&quot;, body.contentType());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            heads.put(&quot;Connection&quot;, &quot;Keep-Alive&quot;);</span><br><span class="line">            heads.put(&quot;Charset&quot;, &quot;UTF-8&quot;);</span><br><span class="line">            return new Request(this);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public enum HttpMethod &#123;</span><br><span class="line">        GET(&quot;GET&quot;),</span><br><span class="line">        POST(&quot;POST&quot;),</span><br><span class="line">        PUT(&quot;PUT&quot;),</span><br><span class="line">        DELETE(&quot;DELETE&quot;);</span><br><span class="line"></span><br><span class="line">        public String methodValue = &quot;&quot;;</span><br><span class="line"></span><br><span class="line">        HttpMethod(String methodValue) &#123;</span><br><span class="line">            this.methodValue = methodValue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public static boolean checkNeedBody(HttpMethod method) &#123;</span><br><span class="line">            return POST.equals(method) || PUT.equals(method);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public static boolean checkNoBody(HttpMethod method) &#123;</span><br><span class="line">            return GET.equals(method) || DELETE.equals(method);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样整个请求块也就构建完毕了。剩下的无非是对具体请求体的抽象的具体实现，我们再看看响应那边怎么实现的。</p>
<h1 id="Response响应的构建"><a href="#Response响应的构建" class="headerlink" title="Response响应的构建"></a><strong>Response响应的构建</strong></h1><h2 id="ResponseBody"><a href="#ResponseBody" class="headerlink" title="ResponseBody"></a><strong>ResponseBody</strong></h2><p>响应体这块主要存储为字节，可以转换成<code>String</code>类型进行返回，不做更具体的解析，没有直接提供流的原因是设计上回调是在主线程中的，如果把流传入有需要自己做异步处理。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public class ResponseBody &#123;</span><br><span class="line"></span><br><span class="line">    byte[] bytes;</span><br><span class="line"></span><br><span class="line">    public ResponseBody(byte[] bytes) &#123;</span><br><span class="line">        this.bytes = bytes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public byte[] bytes() &#123;</span><br><span class="line">        return this.bytes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String string() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            return new String(bytes(), &quot;UTF-8&quot;);</span><br><span class="line">        &#125; catch (UnsupportedEncodingException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        return &quot;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Response"><a href="#Response" class="headerlink" title="Response"></a><strong>Response</strong></h2><p><code>response</code>相对就比较简单了，最关键的是服务端的返回码和响应正文。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">public class Response &#123;</span><br><span class="line"></span><br><span class="line">    final ResponseBody body;</span><br><span class="line">    final String message;</span><br><span class="line">    final int code;</span><br><span class="line"></span><br><span class="line">    public Response(Builder builder) &#123;</span><br><span class="line">        this.body = builder.body;</span><br><span class="line">        this.message = builder.message;</span><br><span class="line">        this.code = builder.code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public ResponseBody body() &#123;</span><br><span class="line">        return this.body;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int code() &#123;</span><br><span class="line">        return this.code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String message() &#123;</span><br><span class="line">        return this.message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    static class Builder &#123;</span><br><span class="line"></span><br><span class="line">        private ResponseBody body;</span><br><span class="line">        private String message;</span><br><span class="line">        private int code;</span><br><span class="line"></span><br><span class="line">        public Builder body(ResponseBody body) &#123;</span><br><span class="line">            this.body = body;</span><br><span class="line">            return this;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public Builder message(String message) &#123;</span><br><span class="line">            this.message = message;</span><br><span class="line">            return this;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public Builder code(int code) &#123;</span><br><span class="line">            this.code = code;</span><br><span class="line">            return this;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public Response build() &#123;</span><br><span class="line">            if (message == null) throw new NullPointerException(&quot;response message == null&quot;);</span><br><span class="line">            if (body == null) throw new NullPointerException(&quot;response body == null&quot;);</span><br><span class="line">            return new Response(this);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样基本的请求和响应对象构建好了，中间需要向上面构建的方式进行调用，还需要引入<code>Call</code>和<code>Callback</code>作为请求的发起和回调接口。</p>
<h1 id="请求发起和结果回调"><a href="#请求发起和结果回调" class="headerlink" title="请求发起和结果回调"></a><strong>请求发起和结果回调</strong></h1><h1 id="Call"><a href="#Call" class="headerlink" title="Call"></a><strong>Call</strong></h1><p><code>call</code>支持同步和异步方式的调用，同步直接返回<code>Response</code>，方法内部阻塞，异步提供一个回调接口回调结果。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public interface Call &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 同步执行</span><br><span class="line">     *</span><br><span class="line">     * @return response</span><br><span class="line">     */</span><br><span class="line">    Response execute();</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 异步执行</span><br><span class="line">     *</span><br><span class="line">     * @param callback 回调接口</span><br><span class="line">     */</span><br><span class="line">    void enqueue(Callback callback);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Callback"><a href="#Callback" class="headerlink" title="Callback"></a><strong>Callback</strong></h2><p><code>Callback</code> 作为回调接口，提供成功和失败的回调，当访问网络成功并成功拿到数据则进入成功的回调，否则进入失败的回调。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public interface Callback &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 当成功拿到结果时返回</span><br><span class="line">     *</span><br><span class="line">     * @param response 　返回结果</span><br><span class="line">     */</span><br><span class="line">    void onResponse(Response response);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 当获取结果失败时</span><br><span class="line">     *</span><br><span class="line">     * @param request 　请求</span><br><span class="line">     * @param e       　Http请求过程中可能产生的异常</span><br><span class="line">     */</span><br><span class="line">    void onFail(Request request, IOException e);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>还有一个关键的就是我们客户端——CatHttp了。</p>
<h2 id="CatHttpClient"><a href="#CatHttpClient" class="headerlink" title="CatHttpClient"></a><strong>CatHttpClient</strong></h2><p><code>CatHttpClient</code> 主要配置了一些超时信息之类的，主要是作为客户端的抽象，作为<code>Call</code>(这一呼叫服务端连接动作的外部发起者)。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">public class CatHttpClient &#123;</span><br><span class="line"></span><br><span class="line">    private Config config;</span><br><span class="line"></span><br><span class="line">    public CatHttpClient(Builder builder) &#123;</span><br><span class="line">        this.config = new Config(builder);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Call newCall(Request request) &#123;</span><br><span class="line">        return new HttpCall(config, request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static class Config &#123;</span><br><span class="line">        final int connTimeout;</span><br><span class="line">        final int readTimeout;</span><br><span class="line">        final int writeTimeout;</span><br><span class="line"></span><br><span class="line">        public Config(Builder builder) &#123;</span><br><span class="line">            this.connTimeout = builder.connTimeout;</span><br><span class="line">            this.readTimeout = builder.connTimeout;</span><br><span class="line">            this.writeTimeout = builder.writeTimeout;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static final class Builder &#123;</span><br><span class="line">        private int connTimeout;</span><br><span class="line">        private int readTimeout;</span><br><span class="line">        private int writeTimeout;</span><br><span class="line"></span><br><span class="line">        public Builder() &#123;</span><br><span class="line">            this.connTimeout = 10 * 1000;</span><br><span class="line">            this.readTimeout = 10 * 1000;</span><br><span class="line">            this.writeTimeout = 10 * 1000;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        public Builder readTimeOut(int readTimeout) &#123;</span><br><span class="line">            this.readTimeout = readTimeout;</span><br><span class="line">            return this;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public Builder connTimeOut(int connTimeout) &#123;</span><br><span class="line">            this.connTimeout = connTimeout;</span><br><span class="line">            return this;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public Builder writeTimeOut(int writeTimeout) &#123;</span><br><span class="line">            this.writeTimeout = writeTimeout;</span><br><span class="line">            return this;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public CatHttpClient build() &#123;</span><br><span class="line">            return new CatHttpClient(this);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这样，请求和响应还有请求和回调的接口都约定好了，关键的就在于任务的执行过程和任务的调度了，因为网络请求都是耗时的，所以必然需要异步去处理网络请求才能最大的发挥框架的性能。我们需要构建一个具体的任务——<code>Task</code>。</p>
<h1 id="Task的执行"><a href="#Task的执行" class="headerlink" title="Task的执行"></a><strong>Task的执行</strong></h1><h2 id="HttpTask"><a href="#HttpTask" class="headerlink" title="HttpTask"></a><strong>HttpTask</strong></h2><p>可以看到，<code>HttpTask</code>实现了<code>Runnable</code>接口，内部实际访问网路请求的操作交给了<code>IRequestHandler</code>来做，回调交给了<code>IResponseHandler</code>来做，最终拿到了<code>Response</code>结果<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">public class HttpTask implements Runnable &#123;</span><br><span class="line"></span><br><span class="line">    private HttpCall call;</span><br><span class="line">    private Callback callback;</span><br><span class="line">    private IRequestHandler requestHandler;</span><br><span class="line">    private IResponseHandler handler = IResponseHandler.RESPONSE_HANDLER;</span><br><span class="line"></span><br><span class="line">    public HttpTask(HttpCall call, Callback callback, IRequestHandler requestHandler) &#123;</span><br><span class="line">        this.call = call;</span><br><span class="line">        this.callback = callback;</span><br><span class="line">        this.requestHandler = requestHandler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void run() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Response response = requestHandler.handlerRequest(call);</span><br><span class="line">            handler.handlerSuccess(callback, response);</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            handler.handFail(callback, call.request, e);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="IRequestHandler"><a href="#IRequestHandler" class="headerlink" title="IRequestHandler"></a><strong>IRequestHandler</strong></h2><p><code>IRequestHandler</code>是实际网络请求的发起者，因为是面向接口编程，外部不用管内部的实现细节，只要调用方法拿到结果就行了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public interface IRequestHandler &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 处理请求</span><br><span class="line">     *</span><br><span class="line">     * @param call 　一次请求发起</span><br><span class="line">     * @return 应答</span><br><span class="line">     * @throws IOException 　网络连接或者其它异常</span><br><span class="line">     */</span><br><span class="line">    Response handlerRequest(HttpCall call) throws IOException;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="IResponseHandler"><a href="#IResponseHandler" class="headerlink" title="IResponseHandler"></a><strong>IResponseHandler</strong></h2><p>看到这里应该明白，这里无非就是包装了一层，实际内部是调用了<code>handler</code>的<code>post(Runnable r)</code>方法将结果回调到主线程中，也就是<code>Callback</code>接口的回调方法被我们切换到了主线程中执行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">public interface IResponseHandler &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 线程切换,http请求成功时的回调</span><br><span class="line">     *</span><br><span class="line">     * @param callback 　回调接口</span><br><span class="line">     * @param response 　返回结果</span><br><span class="line">     */</span><br><span class="line">    void handlerSuccess(Callback callback, Response response);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 线程切换,http请求失败时候的回调</span><br><span class="line">     *</span><br><span class="line">     * @param callback 　回调接口</span><br><span class="line">     * @param request  　请求</span><br><span class="line">     * @param e        　可能产生的异常</span><br><span class="line">     */</span><br><span class="line">    void handFail(Callback callback, Request request, IOException e);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    IResponseHandler RESPONSE_HANDLER = new IResponseHandler() &#123;</span><br><span class="line"></span><br><span class="line">        Handler HANDLER = new Handler(Looper.getMainLooper());</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void handlerSuccess(final Callback callback, final Response response) &#123;</span><br><span class="line">            Runnable runnable = new Runnable() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public void run() &#123;</span><br><span class="line">                    callback.onResponse(response);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            execute(runnable);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void handFail(final Callback callback, final Request request, final IOException e) &#123;</span><br><span class="line">            Runnable runnable = new Runnable() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public void run() &#123;</span><br><span class="line">                    callback.onFail(request, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            execute(runnable);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        /**</span><br><span class="line">         * 移除所有消息</span><br><span class="line">         */</span><br><span class="line">        public void removeAllMessage() &#123;</span><br><span class="line">            HANDLER.removeCallbacksAndMessages(null);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        /**</span><br><span class="line">         * 线程切换</span><br><span class="line">         * @param runnable</span><br><span class="line">         */</span><br><span class="line">        private void execute(Runnable runnable) &#123;</span><br><span class="line">            HANDLER.post(runnable);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="任务调度"><a href="#任务调度" class="headerlink" title="任务调度"></a><strong>任务调度</strong></h1><p>可以看到，上面所有的内容，就差一点能够全部连通，就在于任务的调度，也就是调用线程的执行，必然在Call实体类的<code>enqueue</code>和<code>execute</code>方法中通过任务调度来执行<code>Runnable</code>内部的逻辑的。</p>
<h2 id="HttpThreadPool"><a href="#HttpThreadPool" class="headerlink" title="HttpThreadPool"></a><strong>HttpThreadPool</strong></h2><p>可以看到，作为一个单例类，内部对外提供了同步执行和异步执行task的接口，内部通过线程池来实现，采用生产者-消费者模式，所有客户端提交的任务都会先进入到无界队列<code>BlockingQueue</code>中，线程池满的拒绝策略也是将当前无法被执行的任务放入<code>BlockingQueue</code>中，而在一开始就开了一个<code>Runnable</code>死循环从<code>BlockingQueue</code>中不断取任务执行。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">public class HttpThreadPool &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 线程核心数</span><br><span class="line">     */</span><br><span class="line">    public static final int CORE_POOL_SIZE = Runtime.getRuntime().availableProcessors();</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 最大存活时间</span><br><span class="line">     */</span><br><span class="line">    public static final int LIVE_TIME = 10;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 单例对象</span><br><span class="line">     */</span><br><span class="line">    private static volatile HttpThreadPool threadPool;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 无界队列</span><br><span class="line">     */</span><br><span class="line">    private BlockingQueue&lt;Future&lt;?&gt;&gt; queue = new LinkedBlockingQueue&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 线程池</span><br><span class="line">     */</span><br><span class="line">    private ThreadPoolExecutor executor;</span><br><span class="line"></span><br><span class="line">    public static HttpThreadPool getInstance() &#123;</span><br><span class="line">        if (threadPool == null) &#123;</span><br><span class="line">            synchronized (HttpThreadPool.class) &#123;</span><br><span class="line">                if (threadPool == null) &#123;</span><br><span class="line">                    threadPool = new HttpThreadPool();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return threadPool;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private HttpThreadPool() &#123;</span><br><span class="line">	   executor = new ThreadPoolExecutor(CORE_POOL_SIZE, CORE_POOL_SIZE+1, LIVE_TIME , TimeUnit.SECONDS, new ArrayBlockingQueue&lt;Runnable&gt;(4), rejectHandler);</span><br><span class="line">       executor.execute(runnable);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 消费者</span><br><span class="line">     */</span><br><span class="line">    Runnable runnable = new Runnable() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            while (true) &#123;</span><br><span class="line">                FutureTask&lt;?&gt; task = null;</span><br><span class="line">                try &#123;</span><br><span class="line">                    task = (FutureTask&lt;?&gt;) queue.take();</span><br><span class="line">                &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                if (task != null) &#123;</span><br><span class="line">                    executor.execute(task);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 同步提交任务</span><br><span class="line">     *</span><br><span class="line">     * @param task 　任务</span><br><span class="line">     * @return response对象</span><br><span class="line">     * @throws ExecutionException</span><br><span class="line">     * @throws InterruptedException</span><br><span class="line">     */</span><br><span class="line">    public synchronized Response submit(Callable&lt;Response&gt; task) throws ExecutionException, InterruptedException &#123;</span><br><span class="line">        if (task == null) throw new NullPointerException(&quot;task == null , 无法执行&quot;);</span><br><span class="line">        Future&lt;Response&gt; future = executor.submit(task);</span><br><span class="line">        return future.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 添加异步任务</span><br><span class="line">     *</span><br><span class="line">     * @param task</span><br><span class="line">     */</span><br><span class="line">    public void execute(FutureTask&lt;?&gt; task) &#123;</span><br><span class="line">        if (task == null) throw new NullPointerException(&quot;task == null , 无法执行&quot;);</span><br><span class="line">        try &#123;</span><br><span class="line">            queue.put(task);</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 拒绝策略，如果当线程池中的阻塞队列满，则添加到link队列中</span><br><span class="line">     */</span><br><span class="line">    RejectedExecutionHandler rejectHandler = new RejectedExecutionHandler() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void rejectedExecution(Runnable runnable, ThreadPoolExecutor threadPoolExecutor) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                queue.put(new FutureTask&lt;&gt;(runnable, null));</span><br><span class="line">            &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h1><p>可以看到，上面除了调度的<code>HttpThreadPool</code>类，其余类基本都是抽象类或者接口，但是上面的这些接口和抽象类，相信看懂的童鞋应该明白，网络框架已经可以”运行”了。这里的运行当然不是说能在编译器或者具体的手机上运行，但是框架内部已经打通了任督二脉，可以完美的调度了。代码在<code>github</code>上——<a href="https://github.com/pan-haos/CatHttp" target="_blank" rel="noopener">传送门</a></p>
<p><img src="http://img.blog.csdn.net/20180119144252560?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcGFuODYxMTkwMDc5/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>

                    
                    <!-- Tags Bottom -->
                    

                    <!-- Comments -->
                    



                </div>
                <div class="fl w-100 w-30-l center fw3 lh-copy pl4-ns tl black-50">
                    
                    <hr class="dn-l mw4 black-50 mt5" />
                    
                    <!-- Widget 1: About -->
                    <div class="mt5 mt0-l">
    <article class="dt db-l mw8 mw8-m mw5-ns center ml0-l bg-white mv3">
        <div class="dn dtc-m db-l v-mid tc pr4 pr0-l" style="min-width: 6rem;">
            <img src="http://tachyons.io/img/avatar_1.jpg" class="mb4-l br-100 h3 w3 h4-l w4-l dib" title="Pan Hao">
        </div>
        <div class="dtc db-l v-mid lh-copy measure center f6 black-50 tj">
            My name is Jonathan Klughertz and this is my blog.<br>I am a full stack software engineer with a strong front-end focus.<br> I currently live and work in Singapore, hit me up if you are in the region.
        </div>
    </article>
</div>

                    <hr class="dn-l mw4 black-50 mt5" />
                    
                    <!-- Widget 2: Categories -->
                    

                    <!-- Widget 3: Recent Posts -->
                    <div class="mt5 tc tl-l">
    <h3>Recent Posts</h3>
    
        <p>
            <a href="/2018/06/26/手写Android网络框架——CatHttp（一）/">手写Android网络框架——CatHttp（二）</a>
        </p>
    
        <p>
            <a href="/2018/06/25/hello-world/">Hello World</a>
        </p>
    
</div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Footer -->
<div class="bg-1 ph2 ph5-ns pv5">
        <div class="mv8">
            <div class="center tc">
                
                    <div class="dib mh3">
                        <a class="f3 f2-ns white dim" href="https://twitter.com/?lang=en" target="_blank">
                            <i class="fa fa-twitter"></i>
                        </a>
                    </div>
                
                    <div class="dib mh3">
                        <a class="f3 f2-ns white dim" href="https://www.facebook.com/" target="_blank">
                            <i class="fa fa-facebook"></i>
                        </a>
                    </div>
                
                    <div class="dib mh3">
                        <a class="f3 f2-ns white dim" href="https://dribbble.com/" target="_blank">
                            <i class="fa fa-dribbble"></i>
                        </a>
                    </div>
                
                    <div class="dib mh3">
                        <a class="f3 f2-ns white dim" href="https://github.com/klugjo/hexo-theme-anodyne" target="_blank">
                            <i class="fa fa-github"></i>
                        </a>
                    </div>
                
                    <div class="dib mh3">
                        <a class="f3 f2-ns white dim" href="https://plus.google.com/" target="_blank">
                            <i class="fa fa-google-plus"></i>
                        </a>
                    </div>
                
                    <div class="dib mh3">
                        <a class="f3 f2-ns white dim" href="https://www.behance.net/" target="_blank">
                            <i class="fa fa-behance"></i>
                        </a>
                    </div>
                
                    <div class="dib mh3">
                        <a class="f3 f2-ns white dim" href="https://500px.com/" target="_blank">
                            <i class="fa fa-500px"></i>
                        </a>
                    </div>
                
                    <div class="dib mh3">
                        <a class="f3 f2-ns white dim" href="mailto:test@example.com" target="_blank">
                            <i class="fa fa-envelope"></i>
                        </a>
                    </div>
                
                    <div class="dib mh3">
                        <a class="f3 f2-ns white dim" href="/#" target="_blank">
                            <i class="fa fa-rss"></i>
                        </a>
                    </div>
                
            </div>
            <div class="f6 f5-ns center tc white pt5 fw3">
                @Untitled. All right reserved | Design & Hexo <a class="link dim white" href="http://www.codeblocq.com/">Jonathan Klughertz</a>
            </div>
        </div>
    </div>

<!-- After Footer -->
<!-- Disqus Comments -->



</body>

</html>